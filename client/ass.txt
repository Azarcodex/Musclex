const handleRazorpayPayment = () => {
  if (!selectedAddress) {
    toast.error("Select an address first");
    return;
  }

  const amount = Number(finalTotal);

  const cleanedFinalItems = finalItems.map((item) => ({
    productID: item.productId?._id,
    variantID: item.variantId?._id,
    vendorID: item.productId?.vendorID,
    quantity: item.quantity,
    sizeLabel: item.sizeLabel,
    price: item.finalPrice,
  }));

  const orderPayload = {
    addressID: selectedAddress,
    orderedItems: cleanedFinalItems,
    paymentMethod: "Razorpay",
    totalPrice: subtotal,
    discount,
    finalAmount: finalTotal,
    couponCode: passcoupon || null,
  };

  createRazorpayOrder(
    { amount, orderPayload },
    {
      onSuccess: (data) => {
        const options = {
          key: import.meta.env.VITE_RAZORPAY_KEY_ID,
          amount: data.amount,
          currency: "INR",
          order_id: data.razorpayOrderId,
          name: "Muscle X",
          description: "Order Payment",

          handler: function (response) {
            verifyPayment(
              {
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                orderPayload,
              },
              {
                onSuccess: (res) => {
                  toast.success("Payment Successful!");
                  navigate(`/user/ordersuccess/${res.order._id}`, {
                    replace: true,
                  });
                },
                onError: () => {
                  navigate(`/user/orderfailed/${data.tempOrderId}`, {
                    replace: true,
                  });
                },
              }
            );
          },

          theme: { color: "#8B5CF6" },
        };

        const rzp = new window.Razorpay(options);

        // REAL FAIL HANDLER
        rzp.on("payment.failed", () => {
          rzp.close();
          navigate(`/user/orderfailed/${data.tempOrderId}`, {
            replace: true,
          });
        });

        rzp.open();
      },

      onError: () => toast.error("Failed to initialize payment"),
    }
  );
};
