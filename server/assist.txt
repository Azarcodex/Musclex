// import Order from "../../models/users/order.js";
// import mongoose from "mongoose";

// export const salesReport = async (req, res) => {
//   try {
//     // üîπ Vendor identity (set from auth middleware)
//     const vendorId = req.vendor._id; // or req.user._id if you're storing vendor there

//     if (!vendorId) {
//       return res.status(400).json({ message: "Vendor not identified" });
//     }

//     const page = parseInt(req.query.page) || 1;
//     const limit = parseInt(req.query.limit) || 10;
//     const skip = (page - 1) * limit;

//     const { filter } = req.body || {};

//     // üîπ Base match: only delivered orders
//     const matchStage = {
//       orderStatus: "Delivered",
//     };

//     // üîπ Date filter
//     if (filter && filter.type) {
//       const now = new Date();
//       let start, end;

//       if (filter.type === "day") {
//         end = now;
//         start = new Date(now);
//         start.setDate(now.getDate() - 1);
//       } else if (filter.type === "week") {
//         end = now;
//         start = new Date(now);
//         start.setDate(now.getDate() - 7);
//       } else if (filter.type === "month") {
//         end = now;
//         start = new Date(now);
//         start.setDate(now.getDate() - 30);
//       } else if (filter.type === "range" && filter.from && filter.to) {
//         start = new Date(filter.from + "T00:00:00.000Z");
//         end = new Date(filter.to + "T23:59:59.999Z");
//       }

//       if (start && end) {
//         matchStage.createdAt = { $gte: start, $lte: end };
//       }
//     }

//     const vendorObjectId = new mongoose.Types.ObjectId(vendorId);

//     // 1Ô∏è‚É£ Pipeline used as base for both count + data
//     const basePipeline = [
//       { $match: matchStage },
//       { $unwind: "$orderedItems" },

//       // Lookup variant
//       {
//         $lookup: {
//           from: "variants",
//           localField: "orderedItems.variantID",
//           foreignField: "_id",
//           as: "variants",
//         },
//       },
//       { $unwind: "$variants" },

//       // Lookup product (vendor is here)
//       {
//         $lookup: {
//           from: "products",
//           localField: "orderedItems.productID",
//           foreignField: "_id",
//           as: "products",
//         },
//       },
//       { $unwind: "$products" },

//       // üî• Filter only THIS vendor's items
//       {
//         $match: {
//           "products.vendorID": vendorObjectId,
//         },
//       },

//       // Lookup customer
//       {
//         $lookup: {
//           from: "users",
//           localField: "userID",
//           foreignField: "_id",
//           as: "customer",
//         },
//       },
//       { $unwind: "$customer" },
//     ];

//     // 2Ô∏è‚É£ Get total count for pagination
//     const countPipeline = [...basePipeline, { $count: "count" }];

//     const totalCountResult = await Order.aggregate(countPipeline);
//     const totalCount =
//       totalCountResult.length > 0 ? totalCountResult[0].count : 0;
//     const totalPages = Math.ceil(totalCount / limit) || 1;

//     // 3Ô∏è‚É£ Get paginated rows
//     const ordersPipeline = [
//       ...basePipeline,
//       {
//         $project: {
//           _id: 0,
//           orderId: "$_id",
//           orderDate: "$createdAt",
//           customerName: "$customer.name",
//           productName: "$products.name",
//           flavour: "$variants.flavour",
//           sizeLabel: "$orderedItems.sizeLabel",
//           quantity: "$orderedItems.quantity",
//           price: "$orderedItems.price",
//           total: {
//             $multiply: ["$orderedItems.quantity", "$orderedItems.price"],
//           },
//         },
//       },
//       { $sort: { orderDate: -1 } },
//       { $skip: skip },
//       { $limit: limit },
//     ];

//     const orders = await Order.aggregate(ordersPipeline);

//     // 4Ô∏è‚É£ Summary stats for this vendor within same filters
//     const summaryPipeline = [
//       ...basePipeline,
//       {
//         $project: {
//           quantity: "$orderedItems.quantity",
//           total: {
//             $multiply: ["$orderedItems.quantity", "$orderedItems.price"],
//           },
//         },
//       },
//       {
//         $group: {
//           _id: null,
//           totalRevenue: { $sum: "$total" },
//           totalProducts: { $sum: "$quantity" },
//           totalOrders: { $sum: 1 },
//         },
//       },
//     ];

//     const overall = await Order.aggregate(summaryPipeline);

//     const summaryData = overall[0] || {
//       totalRevenue: 0,
//       totalProducts: 0,
//       totalOrders: 0,
//     };

//     return res.status(200).json({
//       success: true,
//       orders,
//       current: page,
//       totalPage: totalPages,
//       tactic: summaryData,
//     });
//   } catch (error) {
//     console.error("Sales report error:", error);
//     return res.status(500).json({ message: "Internal server error" });
//   }
// };