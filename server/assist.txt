import Offer from "../../../models/offer/offer.js";
import Product from "../../../models/products/Product.js";
import Variant from "../../../models/products/Variant.js";

export const getProducts = async (req, res) => {
  try {
    const URL = process.env.BASE_URL;
    const { category, brands, minPrice, maxPrice, rating, sortValue } =
      req.query;

    // Base queries
    const productQuery = { isDeleted: false, isActive: true };
    const variantQuery = { isListed: true };

    if (minPrice || maxPrice) {
      variantQuery["size.salePrice"] = {};
      if (minPrice) variantQuery["size.salePrice"].$gte = Number(minPrice);
      if (maxPrice) variantQuery["size.salePrice"].$lte = Number(maxPrice);
    }

    const variants = await Variant.find(variantQuery).lean();

    if (category) {
      const catArray = Array.isArray(category) ? category : category.split(",");
      productQuery.catgid = { $in: catArray };
    }
    if (brands) {
      const brandArray = Array.isArray(brands) ? brands : brands.split(",");
      productQuery.brandID = { $in: brandArray };
    }
    if (rating) {
      const ratingArray = Array.isArray(rating) ? rating : rating.split(",");
      productQuery.Avgrating = { $in: ratingArray };
    }

    const products = await Product.find(productQuery)
      .populate("catgid", "catgName")
      .populate("brandID", "brand_name")
      .lean();

    // Active category offers
    const today = new Date();
    const activeOffers = await Offer.find({
      isActive: true,
      scope: "Category",
      startDate: { $lte: today },
      endDate: { $gte: today },
    }).lean();

    // Active product offers
    const activeProductOffers = await Offer.find({
      isActive: true,
      scope: "Product",
      startDate: { $lte: today },
      endDate: { $gte: today },
    }).lean();

    const result = products
      .map((product) => {
        // ðŸ”¥ OPTION 1 IMPLEMENTED HERE ðŸ”¥
        const relatedVariants = variants
          .filter(
            (v) => v.productId.toString() === product._id.toString()
          )
          .map((v) => {
            const filteredSizes = v.size?.filter((s) => {
              if (minPrice && maxPrice) {
                return (
                  Number(s.salePrice) >= Number(minPrice) &&
                  Number(s.salePrice) <= Number(maxPrice)
                );
              }
              if (minPrice) return Number(s.salePrice) >= Number(minPrice);
              if (maxPrice) return Number(s.salePrice) <= Number(maxPrice);
              return true;
            });

            if (!filteredSizes || filteredSizes.length === 0) return null;

            return {
              ...v,
              images: (v.images || []).map((img) => `${URL}${img}`),
              sizes: filteredSizes.map((s) => ({
                ...s,
                salePrice: Number(s.salePrice),
                oldPrice: Number(s.oldPrice),
                discount: Math.floor(
                  ((s.oldPrice - s.salePrice) / s.oldPrice) * 100
                ),
              })),
            };
          })
          .filter(Boolean);

        const defaultVariant = relatedVariants[0];
        if (!defaultVariant) return null;

        const defaultSize = defaultVariant.sizes?.[0];
        if (!defaultSize) return null;

        return {
          ...product,
          relatedVariants,
          brand: product.brandID?.brand_name,
          category: product.catgid?.catgName,
          prevImage: defaultVariant.images?.[0],
          discount: defaultSize.discount || 0,
          variants: defaultVariant,
          size: defaultSize,
        };
      })
      .filter(Boolean);

    // ---------------- OFFER APPLICATION ----------------
    result.forEach((product) => {
      const salePrice = product?.size?.salePrice;
      if (!salePrice) return;

      const catOffer = activeOffers.find(
        (off) =>
          off.categoryId?.toString() === product.catgid._id.toString()
      );

      const prodOffer = activeProductOffers.find((off) =>
        off.productIds.some(
          (id) => id.toString() === product._id.toString()
        )
      );

      const computeDiscount = (offer) => {
        if (!offer) return 0;
        return offer.discountType === "percent"
          ? Math.floor((salePrice * offer.value) / 100)
          : offer.value;
      };

      const catDiscount = computeDiscount(catOffer);
      const prodDiscount = computeDiscount(prodOffer);

      let bestOffer = null;
      let bestDiscount = 0;

      if (catDiscount > prodDiscount) {
        bestOffer = catOffer;
        bestDiscount = catDiscount;
      } else if (prodDiscount > 0) {
        bestOffer = prodOffer;
        bestDiscount = prodDiscount;
      }

      if (!bestOffer) return;

      const finalPrice = Math.max(salePrice - bestDiscount, 1);

      product.size.offerApplied = true;
      product.size.offerType = bestOffer.discountType;
      product.size.offerValue = bestOffer.value;
      product.size.offerPrice = bestDiscount;
      product.size.finalPrice = finalPrice;
    });

    // ---------------- SORTING ----------------
    switch (sortValue) {
      case "sortAZ":
        result.sort((a, b) => a.name.localeCompare(b.name));
        break;

      case "sortZA":
        result.sort((a, b) => b.name.localeCompare(a.name));
        break;

      case "sort01":
        result.sort(
          (a, b) =>
            (a.size?.salePrice || 0) - (b.size?.salePrice || 0)
        );
        break;

      case "sort10":
        result.sort(
          (a, b) =>
            (b.size?.salePrice || 0) - (a.size?.salePrice || 0)
        );
        break;

      default:
        result.sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
    }

    res.status(200).json({ success: true, result });
  } catch (error) {
    console.error("getProducts error:", error);
    res
      .status(500)
      .json({ success: false, message: "Internal server error" });
  }
};
