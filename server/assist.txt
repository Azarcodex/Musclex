export async function addFunds(userId, amount, referenceId = null, note = "") {
  if (amount <= 0) throw new Error("Amount must be positive");

  const session = await mongoose.startSession();
  try {
    session.startTransaction();

    const wallet = await Wallet.findOne({ userId }).session(session);
    if (!wallet) throw new Error("Wallet not found");

    // atomic update
    wallet.balance += amount;
    wallet.lastTransactionAt = new Date();
    await wallet.save({ session });

    await createLedgerEntry({
      session,
      walletId: wallet._id,
      userId,
      amount,
      type: "ADD",
      referenceId,
      note,
    });

    await session.commitTransaction();
    return wallet;
  } catch (err) {
    await session.abortTransaction();
    throw err;
  } finally {
    session.endSession();
  }
}